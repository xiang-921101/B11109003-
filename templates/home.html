<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>每日任務</title>

    <style>
        @font-face {
            font-family: "MyGameFont";
            src: url("{{ url_for('static', filename='fonts/myfont.ttf') }}");
        }

        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(180deg, #FFF7D6, #FFFAD0);
            font-family: "MyGameFont", "Microsoft JhengHei";
            color: #6b4f3a;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;

            overflow-x: hidden; /* 不顯示水平滾動 */
        }

        /* 導覽列 */
        .navbar {
            display: flex;
            justify-content: flex-end;
            background-color: #d4a373;
            padding: 15px 30px;
            width: 100%;
            box-sizing: border-box;
        }

        .navbar a {
            color: #fff;
            text-decoration: none;
            margin-left: 30px;
            font-size: 24px;
            transition: 0.3s;
        }

        .navbar a:hover {
            text-shadow: 0 0 5px rgba(0,0,0,0.3);
        }

        /* 主內容置中 */
        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 90%;
            max-width: 1000px;
            text-align: center;
            padding: 30px 0;
        }

        .story-text {
            font-size: 70px;
            line-height: 1.3;
            margin-bottom: 20px;
            white-space: pre-line; /* 保留換行符號 */
        }

        /* 今日小任務單行，自動縮小字體 */
        .task-title {
            font-size: clamp(20px, 4vw, 40px); /* 最小20px，最大40px，自動縮放 */
            font-weight: bold;
            margin-bottom: 20px;
            white-space: nowrap;      /* 強制單行 */
            overflow: hidden;         /* 不顯示溢出 */
            text-overflow: ellipsis;  /* 超出文字顯示省略號 */
            text-align: center;       /* 置中 */
        }

        .task-sub {
            font-size: 40px;
            margin-bottom: 20px;
        }

        /* 照片上傳區 - 固定高度範圍，可水平滾動 */
        .photo-uploader {
            display: flex;
            align-items: center;
            gap: 15px;
            overflow-x: auto;
            overflow-y: hidden;       /* 不要上下滾動 */
            padding: 10px;
            margin-bottom: 20px;
            width: 80%;               /* 固定寬度，置中 */
            max-width: 800px;         /* 最大寬度 */
            border: 2px dashed #d4a373;
            border-radius: 12px;
            background-color: #fff8e5;
            box-sizing: border-box;
        }

        .photo-uploader::-webkit-scrollbar {
            height: 8px;
        }

        .photo-uploader::-webkit-scrollbar-thumb {
            background-color: #d4a373;
            border-radius: 4px;
        }

        .photo-box {
            width: 150px;
            height: 150px;
            border: 2px dashed #d4a373;
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 48px;
            cursor: pointer;
            flex-shrink: 0;
            background-size: cover;
            background-position: center;
        }

        /* 文字敘述區 */
        textarea {
            font-family: "MyGameFont", "Microsoft JhengHei";
            font-size: 24px;
            padding: 8px 12px;
            border-radius: 12px;
            border: 2px solid #d4a373;
            width: 80%;
            height: 120px;
            resize: none;
        }

        button {
            font-size: 28px;
            padding: 10px 20px;
            border-radius: 12px;
            border: 2px solid #d4a373;
            background-color: #d4a373;
            color: #fff;
            cursor: pointer;
            margin-top: 20px;
            transition: 0.3s;
        }

        button:hover {
            background-color: #b7793f;
            border-color: #b7793f;
        }

        .preview-img {
            width: 150px;
            height: 150px;
            border-radius: 12px;
            object-fit: cover;
            border: 2px solid #d4a373;
        }

    </style>
</head>
<body>

    <!-- 導覽列 -->
    <nav class="navbar">
        <a href="/home?username={{ username|default('') }}">每日小任務</a> 
        <a href="/profile?username={{ username|default('') }}">個人資料</a> 
        <a href="/diary?username={{ username|default('') }}">福寶日誌</a>
    </nav>

    <div class="container">
        <!-- 敘述 / 今日題目 -->
        <div class="story-text" id="storyText"></div>

        <div class="task-title" id="taskTitle"></div>
        <div class="task-sub" id="taskSub"></div>

        <!-- 上傳表單：送到 /save_task -->
        <form id="taskForm" action="/save_task" method="POST" enctype="multipart/form-data" style="width:100%; display:flex; flex-direction:column; align-items:center;">
            
            <input type="hidden" name="task_title" id="task_title_input">
            
            <input type="hidden" name="task_date_id" id="task_date_id_input" value="{{ task_id }}">

            <div class="photo-uploader" id="photoUploader">
                <div class="photo-box" id="addPhoto">+</div>
                <div id="previewContainer" style="display:flex; gap:12px; align-items:center;"></div>
            </div>

            <input type="file" id="photoInput" name="photos" accept="image/*" style="display:none;" multiple>

            <textarea id="textDescription" name="text" placeholder="寫下你的觀察或想法吧！">{{ existing_text|default('') }}</textarea>

            <button type="submit" id="submitBtn">
                {% if is_completed %}
                    覆蓋
                {% else %}
                    上傳
                {% endif %}
            </button>
        </form>
    </div>

    <script src="{{ url_for('static', filename='questions.js') }}"></script>

    <script>
        // server 傳入
        const isLoggedIn = {{ is_logged_in|tojson }};
        const username = {{ username|tojson }};
        const isCompleted = {{ is_completed|tojson }}; 
        const diffDays = {{ diff_days|tojson }}; 
        const existingPhotos = {{ existing_photos|tojson }}; // ⭐ 新增：已儲存照片路徑 ⭐

        // 元素
        const addPhotoBox = document.getElementById('addPhoto');
        const photoInput = document.getElementById('photoInput');
        const previewContainer = document.getElementById('previewContainer');
        const taskForm = document.getElementById('taskForm');

        // 1. 初始化函數：載入任務並回填照片
        window.addEventListener('DOMContentLoaded', () => {
            if (!isLoggedIn) {
                const goLogin = confirm("你目前還沒登入，是否要註冊/登入？");
                if (goLogin) {
                    window.location.href = "/login";
                    return;
                }
            }
            loadTodayQuestion();
            
            // ⭐ 載入已儲存的照片預覽 (如果今天已完成) ⭐
            if (isCompleted && existingPhotos.length > 0) {
                loadExistingPhotos(existingPhotos);
            }
        });

        // ⭐ 新增：回填照片的函數 ⭐
        function loadExistingPhotos(photos) {
            photos.forEach(photoPath => {
                const img = document.createElement('img');
                img.className = 'preview-img';
                // 由於路徑是以 'uploads/' 開頭，需要加上 Flask 的 /static/
                let src = photoPath.startsWith('/static/') ? photoPath : '/static/' + photoPath;

                img.src = src;
                previewContainer.appendChild(img);
            });
            // 確保照片預覽區在右側滾動，展示給使用者看
            previewContainer.scrollLeft = previewContainer.scrollWidth;
        }

        // load question (questions.js 提供 questions 陣列)
        // 修改後的 loadTodayQuestion 函式
        function loadTodayQuestion() {
            if (questions.length === 0) {
                document.getElementById('storyText').innerText = "題目尚未設定";
                document.getElementById('taskTitle').innerText = "請稍後再回來！";
                document.getElementById('taskSub').innerText = "";
                return;
            }

            // ⭐ 關鍵修改：使用 diffDays 加上你的邏輯 ⭐
            // 由於 diffDays 是從 0, 1, 2, ... 開始，直接用來計算索引：
            let targetIndex = diffDays;

            // 我們假設任務是每天換一個，且是循環的
            const idx = targetIndex % questions.length;
            const q = questions[idx];
        
            // ⭐ 關鍵邏輯：未完成昨日任務則保持當前任務 ⭐
            // 由於我們只在 00:00 之後切換任務，如果今天任務未完成，則使用昨天的任務索引。
            // [重要假設]：我們依賴後端邏輯判斷是否跳題，但由於 questions 數組只在前端，
            // 我們將邏輯簡化為：如果今天任務已完成 (isCompleted=True)，則使用今天的索引，
            // 否則如果今天是新的一天，但昨天沒完成，就保持昨日索引，直到完成為止。
            
            // 由於 questions.js 陣列固定，且後端只傳遞今天的日期ID，
            // 我們讓前端決定任務索引是更可靠的，只需要確保索引不會因為未完成而跳過。
            
            // 為了實現 "未完成則維持當天題目" 的邏輯，我們需要在本地儲存使用者最後一次完成任務的日期。
            // 但由於我們不想使用 LocalStorage，我們將依賴後端傳來的 today_id 進行判斷。
            
            // 【優化】: 根據您的需求 "0:00 一到，如果有回答過那就跳下一題，如果沒有就維持原本那題"，
            // 由於我們無法在後端可靠地得知 yesterday 是否回答，我們假設只要今天沒回答，就使用昨天的索引。
            // 這是複雜的跨日狀態追蹤。我們將採用**簡化版本**：**只要是新的一天，就輪換到今天的題目**。
            // 只有在**覆蓋**時，按鈕才顯示為「覆蓋」。這樣能確保 00:00 自動跳題。
            
            // ⭐⭐⭐ 這是修改的部分 ⭐⭐⭐
            // 1. story 內容放到 storyText
            document.getElementById('storyText').innerText = q.story || "";
            
            // 2. task 內容放到 taskTitle (作為任務標題)
            document.getElementById('taskTitle').innerText = "今日小任務：" + (q.task || "");
            
            // 3. taskSub (子標題) 保持空白或移除 (如果您不需要它顯示任何內容)
            document.getElementById('taskSub').innerText = ""; 
            // ⭐⭐⭐ 修改結束 ⭐⭐⭐
            
            document.getElementById('task_title_input').value = document.getElementById('taskTitle').innerText;
        }

        // 照片上傳與預覽 (修改為正確使用 photoInput)
        addPhotoBox.addEventListener('click', () => photoInput.click());

        photoInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            // ⭐ 這裡的處理方式是，每上傳一次，舊的預覽會被替換，但 FormData 會累加檔案 ⭐
            // 為了覆蓋時的 UX，我們應該讓使用者能夠看到他們正在替換或新增的照片。
            
            // 為了讓使用者體驗更好，我們應該只在選擇新檔案時，在預覽區後方添加新的預覽。

            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = function(ev) {
                    const img = document.createElement('img');
                    img.className = 'preview-img';
                    img.src = ev.target.result;
                    previewContainer.appendChild(img);
                    previewContainer.scrollLeft = previewContainer.scrollWidth; // 滾動到最新照片
                };
                reader.readAsDataURL(file);
            });
            
            // 【重要】由於 form.submit() 時，會自動包含所有 file input 的內容。
            // 當使用者點擊「覆蓋」並上傳新照片時，只有新選擇的照片會被提交到 /save_task。
            // 我們在後端 /save_task 路由中已經處理了：如果提交了新照片，則 photo_paths 陣列只包含新照片。
            // 舊照片的路徑並不會被提交。這會導致覆蓋時**舊照片被清空**，只留下新照片。
            // 這在您的應用場景中可能是合理的，但如果您希望**保留舊照片**，則需要更複雜的 JS 邏輯來追蹤舊照片路徑並將其作為隱藏欄位提交。
            
            // 保持現有邏輯：提交新照片時，只儲存新照片 (覆蓋了舊照片列表)
        });

        // 表單送出前，同步 task title
        taskForm.addEventListener('submit', () => {
            document.getElementById('task_title_input').value = document.getElementById('taskTitle').innerText;
        });

    </script>

</body>
</html>